<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Verify OTP</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
      integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="assets/img/style.css" />
</head>
<body>
    <style>
      .button-login{
        background-color: black;
      }
      .button-login:hover{
        background-color: black;
      }
      .form-control:focus{
        outline: none; /* Remove default outline */
  border-color: transparent; /* Remove blue border */
  box-shadow: none; /* Remove any shadow effects */
      }
      </style>
    <div class="main" style="border: 5px solid black">
        <div class="container pb-5 mt-2 vh">
            <form id="otpForm" action="javascript:void(0);">
                <div class="ps-3 fs-5 pt-3">
                    <a href="loginForm.html">
                        <i class="fa-solid fa-chevron-left"></i>
                    </a>
                </div>
                <div class="text-start ps-3 mt-3">
                    <h6>Please Enter SMS OTP</h6>
                    <p id="mobileNumberDisplay">SMS OTP sent to </p>
                </div>
                <div class="input-group flex-nowrap bg-light mt-3 rounded">
                    <input
                      type="text"
                      id="otpInput"
                      style="background-color: white;"
                      class="form-control bg-light border-0"
                      placeholder="Enter OTP"
                      aria-label="OTP"
                      required
                    />
                </div>
                <div id="referralCodeContainer" class="text-start ps-3 mt-3" style="display: none;">
                    <h6>Referral Code (optional)</h6>
                    <div class="input-group flex-nowrap bg-light mt-3 rounded">
                        <input
                          type="text"
                          id="referralCodeInput"
                          class="form-control bg-light border-0"
                          placeholder="Enter Referral Code"
                          aria-label="Referral Code"
                        />
                    </div>
                </div>
                <div class="text-center mt-3">
                    <button type="submit" class="btn btn-dark button-login">
                        Verify
                    </button>
                </div>
            </form>
        </div>
    </div>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>
    <script>
        // Display the mobile number stored in localStorage
        const mobileNumber = localStorage.getItem("mobileNumber");
        document.getElementById("mobileNumberDisplay").textContent += mobileNumber;

        // Check if user is registered
        async function checkUserRegistration() {
            try {
                const response = await fetch("https://onexcrypto.xyz/api/user/check-registration", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ mobile: mobileNumber }) // Send mobile number to check registration
                });

                if (response.ok) {
                    const responseData = await response.json();
                    if (responseData.isRegistered) {
                        // User is registered, hide referral code input
                        document.getElementById("referralCodeContainer").style.display = "none";
                    } else {
                        // User is not registered, show referral code input
                        document.getElementById("referralCodeContainer").style.display = "block";
                    }
                }
            } catch (error) {
                console.error("Error checking user registration:", error);
            }
        }

        async function handleOTPSubmit(event) {
            event.preventDefault();

            const otp = document.getElementById("otpInput").value.trim();
            const referralCode = document.getElementById("referralCodeInput").value.trim(); // Get referral code

            if (!otp) {
                alert("Please enter the OTP.");
                return;
            }

            try {
                const response = await fetch("https://onexcrypto.xyz/api/otp/verify-otp", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ mobile: mobileNumber, otp, referralCode }), // Send mobile number, OTP, and referral code
                });

                if (response.ok) {
                    const responseData = await response.json();
                    // Store token and balances in localStorage
                    localStorage.setItem("token", responseData.token);
                    localStorage.setItem("isLoggedIn", true);
                    alert("OTP verified successfully!");
                    window.location.href = "user.html"; // Replace with your actual next page URL
                } else {
                    const errorData = await response.json();
                    console.error("Failed to verify OTP:", errorData);
                    alert("OTP verification failed. Please try again.");
                }
            } catch (error) {
                console.error("Error:", error);
            }
        }

        document.getElementById("otpForm").addEventListener("submit", handleOTPSubmit);

        // Check user registration status on page load
        checkUserRegistration();
    </script>
</body>
</html>
