<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Deposit USDT</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
      integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <style>
      body {
        background-color: #f5f5f5;
      }

      .deposit-card {
        max-width: 400px;
        margin: 50px auto;
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
      }

      .qr-code {
        width: 150px;
        height: 150px;
        margin: 0 auto 20px;
      }

      .countdown {
        font-size: 24px;
        font-weight: bold;
        color: #000;
        text-align: center;
        margin-bottom: 10px;
      }

      .deposit-input {
        background-color: #f9f9f9;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
      }

      .alert-warning {
        font-size: 12px;
        color: #d9534f;
        background-color: #f9f2f4;
        border-color: #eed3d7;
      }

      .btn-cancel {
        background-color: #ff4d4d;
        color: white;
      }

      .btn-cancel:hover {
        background-color: #ff1a1a;
      }
    </style>
  </head>

  <body class="bg-light">
    <div class="container-fluid">
      <div class="deposit-card">
        <div class="d-flex align-items-center mb-3">
          <a
            href="user.html"
            class="back-btn"
            onclick="event.preventDefault(); cancelDeposit();"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              height="24px"
              viewBox="0 -960 960 960"
              width="24px"
              fill="#5f6368"
            >
              <path d="M400-80 0-480l400-400 71 71-329 329 329 329-71 71Z" />
            </svg>
          </a>
          <h5 class="title flex-grow-1 text-center mb-0">Deposit USDT</h5>
        </div>

        <div class="qr-code text-center">
          <img id="qrCodeImage" src="" alt="" />
        </div>

        <div class="countdown" id="countdown">01:39:23 remaining</div>
        <script>
          function startCountdown(duration, display) {
            let timer = duration,
              hours,
              minutes,
              seconds;
            setInterval(function () {
              hours = parseInt(timer / 3600, 10);
              minutes = parseInt((timer % 3600) / 60, 10);
              seconds = parseInt(timer % 60, 10);

              hours = hours < 10 ? "0" + hours : hours;
              minutes = minutes < 10 ? "0" + minutes : minutes;
              seconds = seconds < 10 ? "0" + seconds : seconds;

              display.textContent =
                hours + ":" + minutes + ":" + seconds + " remaining";

              if (--timer < 0) {
                timer = duration;
              }
            }, 1000);
          }

          window.onload = function () {
            const countdownElement = document.getElementById("countdown");
            const countdownTime = 1 * 3600 + 39 * 60 + 23; // 1 hour, 39 minutes, 23 seconds
            startCountdown(countdownTime, countdownElement);
          };
        </script>
        <p class="text-center text-muted">Scan the QR code and pay</p>

        <input
          type="text"
          class="form-control deposit-input"
          id="transactionIdInput"
          placeholder="Please enter Txid"
        />
        <button
          class="btn btn-primary w-100 mb-3"
          onclick="submitTransactionId()"
        >
          Submit
        </button>

        <p class="text-center text-muted">
          Your deposit USDT will be added immediately once Txid is verified
        </p>

        <div class="deposit-details">
          <div class="d-flex justify-content-between">
            <span>Deposit Amount:</span>
            <span id="deposit-amount"></span>
          </div>
          <div class="d-flex justify-content-between">
            <span>Deposit Address:</span>
          </div>
          <div class="d-flex justify-content-between">
            <span
              id="deposit-address"
              style="font-size: small; display: block"
            ></span>
          </div>
          <div class="alert alert-warning text-center mt-3">
            <i class="fas fa-exclamation-triangle"></i> Only support
            <span class="deposit-network"></span>
            Please double-check the address.
          </div>
          <div class="d-flex justify-content-between">
            <span>Deposit ID:</span>
            <span id="deposit-id"></span>
          </div>
          <div class="d-flex justify-content-between">
            <span>Network:</span>
            <span class="deposit-network"></span>
          </div>
          <div class="d-flex justify-content-between">
            <span>Create Time:</span>
            <span id="deposit-createdAt"></span>
          </div>
        </div>

        <button class="btn btn-cancel w-100 mt-4" onclick="cancelDeposit()">
          Cancel
        </button>
      </div>
    </div>
    <script>
      async function authenticate() {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "loginform.html";
          return false; // Return false if no token
        }
        const response = await fetch("https://onexcrypto.xyz/api/authUser", {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
        });
        const result = await response.json();
        if (!result.success) {
          window.location.href = "loginform.html";
          return false; // Return false if authentication fails
        }
        return true; // Return true if authentication is successful
      }
      var deposit = {};
      async function initPage() {
        const isAuthenticated = await authenticate();
        if (isAuthenticated) {
          // Only run the rest of the code if authenticated
          deposit = JSON.parse(localStorage.getItem("deposit")) || {};
          const qrCodeImageElement = document.getElementById("qrCodeImage");
          console.log("Deposit:", deposit);
          qrCodeImageElement.src = deposit.qrCodeUrl || "";
          const depositAddressElement =
            document.getElementById("deposit-address");
          depositAddressElement.textContent = deposit.address || "N/A";
          const depositAmountElement =
            document.getElementById("deposit-amount");
          depositAmountElement.textContent = deposit.amount || "N/A";
          const depositIdElement = document.getElementById("deposit-id");
          depositIdElement.textContent = deposit.id || "N/A";
          const depositNetworkElements =
            document.getElementsByClassName("deposit-network");
          for (let element of depositNetworkElements) {
            element.textContent = deposit.network || "N/A";
          }
          const depositCreatedAtElement =
            document.getElementById("deposit-createdAt");
          if (deposit.createdAt) {
            const date = new Date(deposit.createdAt);
            const formattedDate = date.toLocaleString();
            depositCreatedAtElement.textContent = formattedDate;
          } else {
            depositCreatedAtElement.textContent = "N/A";
          }
        }
      }

      async function submitTransactionId() {
        const transactionId =
          document.getElementById("transactionIdInput").value;
        const token = localStorage.getItem("token");

        if (transactionId && token) {
          try {
            const response = await fetch(
              "https://onexcrypto.xyz/api/deposit/submit-transaction-id",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({
                  transactionId: transactionId,
                  depositId: deposit.id,
                }),
              }
            );
            const data = await response.json();
            if (data.success) {
              alert("Transaction ID submitted successfully.");
              // Optionally, redirect or update the UI
              window.location.href = "user.html";
            } else {
              alert("Failed to submit transaction ID.");
              await cancelDeposit();
              window.location.href = "user.html";
            }
          } catch (error) {
            console.error("Error:", error);
            alert("An error occurred while submitting the transaction ID.");
          }
        } else {
          alert("Transaction ID or user token is missing.");
        }
      }

      async function cancelDeposit() {
        // Implement the logic to cancel the deposit
        const id = deposit.id;
        const token = localStorage.getItem("token");
        console.log("Transaction ID:", id);
        if (id) {
          try {
            const response = await fetch(
              "https://onexcrypto.xyz/api/delete-transaction",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ transactionId: id }),
              }
            );
            const data = await response.json();
            if (data.success) {
              alert("Deposit cancelled successfully.");
              localStorage.removeItem("deposit");
              window.location.href = "user.html";
            } else {
              alert("Failed to cancel deposit.");
              localStorage.removeItem("deposit");
              window.location.href = "user.html";
            }
          } catch (error) {
            console.error("Error:", error);
            alert("An error occurred while cancelling the deposit.");
          }
        } else {
          alert("Transaction ID is missing.");
        }
      }

      document.addEventListener("DOMContentLoaded", initPage);
    </script>

    <script
      src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
      integrity="sha384-Ksv2f/2neEeWfr0GQpMECkCdY1PZK7jP91N2JqY+5qz4dG14T+4VNh2zMih44s3b"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js"
      integrity="sha384-cse3FgjAn/AeEK4mQf7Rq4aWe1n9GfKwZCdRtEjkBq3hrC8fj3L82xMI9co36oA9"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
